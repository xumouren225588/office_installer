name: Build Office Installer

on:
  issues:
    types: [opened, edited]

jobs:
  build:
    # ä»…åœ¨æ ‡é¢˜ä»¥ build å¼€å¤´æ—¶è¿è¡Œ
    if: startsWith(github.event.issue.title, 'build')
    runs-on: windows-latest

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout
        uses: actions/checkout@v4

      # 2. å°† Issue æ­£æ–‡å†™å…¥ config.xml
      - name: Write config.xml from issue body
        shell: pwsh
        run: |
          $body = @"
          ${{ github.event.issue.body }}
          "@
          $body | Out-File -FilePath "${{ github.workspace }}\config.xml" -Encoding utf8NoBOM

      # 3. ä¸‹è½½ 7zrï¼ˆ7-Zip è½»é‡å‘½ä»¤è¡Œç‰ˆï¼‰
      - name: Download 7zr
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "https://www.7-zip.org/a/7zr.exe" -OutFile ".\7zr.exe"

      # 4. è¿è¡Œ setup.exe /download config.xml
      - name: Download Office
        shell: cmd
        run: |
          .\setup.exe /download config.xml

      # 5. ä½¿ç”¨ 7zr æ‰“åŒ… Office æ–‡ä»¶å¤¹ã€setup.exeã€config.xml ä¸º pack.7z
      - name: Create pack.7z with 7zr
        shell: cmd
        run: |
          .\7zr a -t7z pack.7z Office setup.exe config.xml

      # 6. ç”¨ copy /b åˆå¹¶ 7zsd.sfx + config.txt + pack.7z -> inst.exe
      - name: Build inst.exe
        shell: cmd
        run: |
          copy /b 7zsd.sfx + config.txt + pack.7z inst.exe

      # 7. ä¸Šä¼ å·¥ä»¶ï¼ˆä¿ç•™ 1 å¤©ï¼‰
      - name: Upload inst.exe
        uses: actions/upload-artifact@v4
        with:
          name: inst
          path: inst.exe
          retention-days: 1

      # 8. è‡ªåŠ¨å…³é—­è§¦å‘æœ¬æ¬¡æ„å»ºçš„ Issue
      - name: Generate random filename
        id: name
        shell: pwsh
        run: |
          $rand = [System.IO.Path]::GetRandomFileName().Replace(".", "")
          $fname = "inst_$rand.exe"
          "fname=$fname" >> $env:GITHUB_OUTPUT

      - name: Upload inst.exe to 123äº‘ç›˜
        id: upload
        shell: pwsh
        env:
          TOKEN: ${{ secrets.ACCESS_TOKEN }}
          FNAME: ${{ steps.name.outputs.fname }}
        run: |
          # 1. MD5 & Size
          $etag  = (Get-FileHash -Algorithm MD5 -Path "inst.exe").Hash.ToLower()
          $size  = (Get-Item "inst.exe").Length

          # 2. åˆ›å»ºæ–‡ä»¶
          $body  = @{ parentFileID=0; filename=$env:FNAME; etag=$etag; size=$size } | ConvertTo-Json
          $resp  = Invoke-RestMethod -Uri "https://open-api.123pan.com/upload/v1/file/create" `
                      -Method Post -Headers @{ "Platform"="open_platform"; "Authorization"="Bearer $env:TOKEN" } `
                      -ContentType "application/json" -Body $body
          $preID = $resp.data.preuploadID

          # 3. è·å–ä¸Šä¼ åœ°å€ï¼ˆå…³é”®ä¿®å¤ï¼‰
          $urlResp = Invoke-RestMethod -Uri "https://open-api.123pan.com/upload/v1/file/get_upload_url" `
                       -Method Post -Headers @{ "Platform"="open_platform"; "Authorization"="Bearer $env:TOKEN" } `
                       -ContentType "application/json" `
                       -Body (@{ preuploadID=$preID; sliceNo=1 } | ConvertTo-Json)
          $uploadUrl = [System.Net.WebUtility]::UrlDecode($urlResp.data.presignedURL)
          if ([string]::IsNullOrEmpty($uploadUrl)) {
            throw "è·å–ä¸Šä¼ åœ°å€å¤±è´¥ï¼Œè¿”å›: $($urlResp | ConvertTo-Json -Depth 10)"
          }

          # 4. PUT ä¸Šä¼ 
          try {
            Invoke-RestMethod -Uri $uploadUrl -Method Put -InFile "inst.exe" -ContentType "application/octet-stream"
          } catch {
            throw "ä¸Šä¼ æ–‡ä»¶å¤±è´¥ï¼Œé”™è¯¯: $_"
          }

          # 5. ä¸Šä¼ å®Œæˆ
          Invoke-RestMethod -Uri "https://open-api.123pan.com/upload/v2/file/upload_complete" `
            -Method Post -Headers @{ "Platform"="open_platform"; "Authorization"="Bearer $env:TOKEN" } `
            -ContentType "application/json" `
            -Body (@{ preuploadID=$preID } | ConvertTo-Json)

          # 6. å†æ¬¡åˆ›å»ºæ–‡ä»¶æ‹¿ fileID
          $resp2  = Invoke-RestMethod -Uri "https://open-api.123pan.com/upload/v1/file/create" `
                       -Method Post -Headers @{ "Platform"="open_platform"; "Authorization"="Bearer $env:TOKEN" } `
                       -ContentType "application/json" -Body $body
          $fileID = $resp2.data.fileID

          # è¾“å‡º
          "fileID=$fileID" >> $env:GITHUB_OUTPUT

      - name: Create share link
        id: share
        shell: pwsh
        env:
          TOKEN: ${{ secrets.ACCESS_TOKEN }}
          FILE_ID: ${{ steps.upload.outputs.fileID }}
          FNAME: ${{ steps.name.outputs.fname }}
        run: |
          $body = @{ shareName=$env:FNAME; shareExpire=0; fileIDList=$env:FILE_ID } | ConvertTo-Json
          $resp = Invoke-RestMethod -Uri "https://open-api.123pan.com/api/v1/share/create" `
            -Method Post -Headers @{ "Platform"="open_platform"; "Authorization"="Bearer $env:TOKEN" } `
            -ContentType "application/json" -Body $body
          $shareKey = $resp.data.shareKey
          $link = "https://www.123pan.com/s/$shareKey"
          "link=$link" >> $env:GITHUB_OUTPUT

      - name: Comment link on issue
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `âœ… æ„å»ºå®Œæˆï¼\nğŸ“¦ æ–‡ä»¶åï¼š${{ steps.name.outputs.fname }}\nğŸ”— ä¸‹è½½ï¼š${{ steps.share.outputs.link }}`
            });
