name: Build Office Installer

on:
  issues:
    types: [opened, edited]

jobs:
  build:
    # 仅当标题以 build 开头（不区分大小写）
    if: startsWith(github.event.issue.title, 'build')
    runs-on: windows-latest

    steps:
      # 1. 检出代码
      - name: Checkout
        uses: actions/checkout@v4

      # 2. 将 Issue 正文写入 config.xml
      - name: Write config.xml from issue body
        shell: pwsh
        run: |
          $body = @"
          ${{ github.event.issue.body }}
          "@
          $body | Out-File -FilePath "${{ github.workspace }}\config.xml" -Encoding utf8NoBOM

      # 3. 运行 setup.exe /download config.xml
      - name: Download Office
        shell: cmd
        run: |
          .\setup.exe /download config.xml

      # 4. 打包 Office 文件夹、setup.exe、config.xml 为 pack.7z
      - name: Create pack.7z
        shell: cmd
        run: |
          7z a -t7z pack.7z Office setup.exe config.xml

      # 5. 用 copy /b 合并 7zsd.sfx + config.txt + pack.7z -> inst.exe
      - name: Build inst.exe
        shell: cmd
        run: |
          copy /b 7zsd.sfx + config.txt + pack.7z inst.exe

      # 6. 上传工件（保留 1 天）
      - name: Upload inst.exe
        uses: actions/upload-artifact@v4
        with:
          name: inst
          path: inst.exe
          retention-days: 1
