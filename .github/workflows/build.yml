name: Build Office Installer

on:
  issues:
    types: [opened, edited]

jobs:
  build:
    if: startsWith(github.event.issue.title, 'build')
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Write config.xml from issue body
        shell: pwsh
        run: |
          $body = @"
          ${{ github.event.issue.body }}
          "@
          $body | Out-File -FilePath "${{ github.workspace }}\config.xml" -Encoding utf8NoBOM

      - name: Download 7zr
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "https://www.7-zip.org/a/7zr.exe" -OutFile ".\7zr.exe"

      - name: Download Office
        shell: cmd
        run: |
          .\setup.exe /download config.xml

      - name: Create pack.7z with 7zr
        shell: cmd
        run: |
          .\7zr a -t7z pack.7z Office setup.exe config.xml

      - name: Build inst.exe
        shell: cmd
        run: |
          copy /b 7zsd.sfx + config.txt + pack.7z inst.exe

      - name: Upload inst.exe
        id: upload-artifact  # 定义ID用于后续获取工件信息
        uses: actions/upload-artifact@v4
        with:
          name: inst
          path: inst.exe
          retention-days: 1

      - name: Generate nightly.link and create download task
        shell: cmd
        env:
          # 替换为你的123云盘API密钥（建议通过GitHub Secrets存储）
          API_TOKEN: ${{ secrets.ACCESS_TOKEN }}
          # 工件ID从上传步骤的输出获取
          ARTIFACT_ID: ${{ steps.upload-artifact.outputs.artifact-id }}
          # 你的GitHub用户名和仓库名
          GITHUB_USER: xumouren225588
          GITHUB_REPO: office_installer
          # 目标文件夹ID
          FOLDER_ID: 19960178
        run: |
          # 生成nightly.link链接
          set NIGHTLY_LINK=nightly.link/%GITHUB_USER%/%GITHUB_REPO%/actions/artifacts/%ARTIFACT_ID%.zip
          
          # 调用123云盘API创建离线下载任务（参考文档：https://123yunpan.yuque.com/org-wiki-123yunpan-muaork/cr6ced/he47hsq2o1xvgado）
          curl -X POST "https://open-api.123pan.com/api/v1/offline/download" ^
            -H "Authorization: Bearer %API_TOKEN%" ^
            -H "Platform: open_platform"
            -H "Content-Type: application/json" ^
            -d "{\"url\":\"https://%NIGHTLY_LINK%\", \"folder_id\": %FOLDER_ID%}"

      - name: Close issue
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: 'closed'
            });
