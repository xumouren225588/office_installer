name: Build Office Installer

on:
  issues:
    types: [opened, edited]

jobs:
  build:
    # ä»…åœ¨æ ‡é¢˜ä»¥ build å¼€å¤´æ—¶è¿è¡Œ
    if: startsWith(github.event.issue.title, 'build')
    runs-on: windows-latest

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout
        uses: actions/checkout@v4

      # 2. å°† Issue æ­£æ–‡å†™å…¥ config.xml
      - name: Write config.xml from issue body
        shell: pwsh
        run: |
          $body = @"
          ${{ github.event.issue.body }}
          "@
          $body | Out-File -FilePath "${{ github.workspace }}\config.xml" -Encoding utf8NoBOM

      # 3. ä¸‹è½½ 7zrï¼ˆ7-Zip è½»é‡å‘½ä»¤è¡Œç‰ˆï¼‰
      - name: Download 7zr
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "https://www.7-zip.org/a/7zr.exe" -OutFile ".\7zr.exe"

      # 4. è¿è¡Œ setup.exe /download config.xml
      - name: Download Office
        shell: cmd
        run: |
          .\setup.exe /download config.xml

      # 5. ä½¿ç”¨ 7zr æ‰“åŒ… Office æ–‡ä»¶å¤¹ã€setup.exeã€config.xml ä¸º pack.7z
      - name: Create pack.7z with 7zr
        shell: cmd
        run: |
          .\7zr a -t7z pack.7z Office setup.exe config.xml

      # 6. ç”¨ copy /b åˆå¹¶ 7zsd.sfx + config.txt + pack.7z -> inst.exe
      - name: Build inst.exe
        shell: cmd
        run: |
          copy /b 7zsd.sfx + config.txt + pack.7z inst.exe

      # 7. ä¸Šä¼ å·¥ä»¶ï¼ˆä¿ç•™ 1 å¤©ï¼‰
      - name: Upload inst.exe
        uses: actions/upload-artifact@v4
        with:
          name: inst
          path: inst.exe
          retention-days: 1

      # 8. è‡ªåŠ¨å…³é—­è§¦å‘æœ¬æ¬¡æ„å»ºçš„ Issue
      - name: Generate random filename
        id: name
        run: echo "fname=inst-$(date +%s%N | sha256sum | head -c 8).exe" >> "$GITHUB_OUTPUT"

      - name: Upload to 123äº‘ç›˜
        id: upload
        env:
          TOKEN: ${{ secrets.ACCESS_TOKEN }}
          FNAME: ${{ steps.name.outputs.fname }}
        run: |
          # 1. åˆ›å»ºæ–‡ä»¶ï¼ˆè·å– preuploadIDï¼‰
          RESP=$(curl -s https://open-api.123pan.com/upload/v1/file/create \
            -H 'Platform: open_platform' \
            -H 'Content-Type: application/json' \
            -H "Authorization: Bearer $TOKEN" \
            -d "{
                  \"parentFileID\": 0,
                  \"filename\": \"$FNAME\",
                  \"etag\": \"$(md5sum inst.exe | cut -d' ' -f1)\",
                  \"size\": $(stat -c%s inst.exe)
                }")
          PRE_ID=$(echo "$RESP" | jq -r '.data.preuploadID')
          echo "preuploadID=$PRE_ID" >> $GITHUB_OUTPUT

          # 2. è·å–ä¸Šä¼ åœ°å€
          UP_URL=$(curl -s https://open-api.123pan.com/upload/v1/file/get_upload_url \
            -H 'Platform: open_platform' \
            -H 'Content-Type: application/json' \
            -H "Authorization: Bearer $TOKEN" \
            -d "{
                  \"preuploadID\": \"$PRE_ID\",
                  \"sliceNo\": 1
                }" | jq -r '.data.uploadUrl')

          # 3. å®é™…ä¸Šä¼ æ–‡ä»¶
          curl -T inst.exe "$UP_URL"

          # 4. ä¸Šä¼ å®Œæˆ
          curl -s https://open-api.123pan.com/upload/v2/file/upload_complete \
            -H 'Platform: open_platform' \
            -H "Authorization: Bearer $TOKEN" \
            -d "{\"preuploadID\":\"$PRE_ID\"}"

          # 5. è·å– fileID
          FILE_ID=$(curl -s https://open-api.123pan.com/upload/v1/file/create \
            -H 'Platform: open_platform' \
            -H 'Content-Type: application/json' \
            -H "Authorization: Bearer $TOKEN" \
            -d "{
                  \"parentFileID\": 0,
                  \"filename\": \"$FNAME\",
                  \"etag\": \"$(md5sum inst.exe | cut -d' ' -f1)\",
                  \"size\": $(stat -c%s inst.exe)
                }" | jq -r '.data.fileID')
          echo "fileID=$FILE_ID" >> $GITHUB_OUTPUT

      - name: Create share link
        id: share
        env:
          TOKEN: ${{ secrets.ACCESS_TOKEN }}
          FILE_ID: ${{ steps.upload.outputs.fileID }}
          FNAME: ${{ steps.name.outputs.fname }}
        run: |
          RESP=$(curl -s https://open-api.123pan.com/api/v1/share/create \
            -H 'Platform: open_platform' \
            -H 'Content-Type: application/json' \
            -H "Authorization: Bearer $TOKEN" \
            -d "{
                  \"shareName\": \"$FNAME\",
                  \"shareExpire\": 0,
                  \"fileIDList\": \"$FILE_ID\"
                }")
          LINK="https://www.123pan.com/s/$(echo "$RESP" | jq -r '.data.shareKey')"
          echo "link=$LINK" >> $GITHUB_OUTPUT

      - name: Comment link on issue
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `âœ… æ„å»ºå®Œæˆï¼ğŸ“¦ æ–‡ä»¶åï¼š${{ steps.name.outputs.fname }}ğŸ”— ä¸‹è½½ï¼š${{ steps.share.outputs.link }}`
            });
