name: Build Office Installer

on:
  issues:
    types: [opened, edited]

jobs:
  build:
    # 仅在标题以 build 开头时运行
    if: startsWith(github.event.issue.title, 'build')
    runs-on: windows-latest

    steps:
      # 1. 检出代码
      - name: Checkout
        uses: actions/checkout@v4

      # 2. 将 Issue 正文写入 config.xml
      - name: Write config.xml from issue body
        shell: pwsh
        run: |
          $body = @"
          ${{ github.event.issue.body }}
          "@
          $body | Out-File -FilePath "${{ github.workspace }}\config.xml" -Encoding utf8NoBOM

      # 3. 下载 7zr（7-Zip 轻量命令行版）
      - name: Download 7zr
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "https://www.7-zip.org/a/7zr.exe" -OutFile ".\7zr.exe"

      # 4. 运行 setup.exe /download config.xml
      - name: Download Office
        shell: cmd
        run: |
          .\setup.exe /download config.xml

      # 5. 使用 7zr 打包 Office 文件夹、setup.exe、config.xml 为 pack.7z
      - name: Create pack.7z with 7zr
        shell: cmd
        run: |
          .\7zr a -t7z pack.7z Office setup.exe config.xml

      # 6. 用 copy /b 合并 7zsd.sfx + config.txt + pack.7z -> inst.exe
      - name: Build inst.exe
        shell: cmd
        run: |
          copy /b 7zsd.sfx + config.txt + pack.7z inst.exe

      - name: Generate release tag
        id: rel
        shell: pwsh
        run: |
          $tag = "v$(Get-Date -Format 'yyyy.MM.dd-HHmmss')"
          echo "TAG=$tag" >> $env:GITHUB_OUTPUT

      # 8. 创建正式 Release
      - name: Create release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.rel.outputs.TAG }}
          name: Office Installer ${{ steps.rel.outputs.TAG }}
          body: |
            自动构建，触发 Issue #${{ github.event.issue.number }}
          files: inst.exe
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 9. 在 Issue 追加评论并关闭
      - name: Comment and close
        uses: actions/github-script@v7
        with:
          script: |
            const releaseUrl = '${{ steps.create_release.outputs.url }}';
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `✅ 构建完成，下载地址：${releaseUrl}`
            });
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: 'closed'
            });
